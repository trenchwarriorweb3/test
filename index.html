<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DeCasino - On-Chain Lottery</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0a0e27 0%, #1a1f3a 50%, #2d1b4e 100%);
            min-height: 100vh;
            color: #fff;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
        }

        header {
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(20px);
            padding: 1.2rem 0;
            position: sticky;
            top: 0;
            z-index: 1000;
            border-bottom: 2px solid rgba(139, 92, 246, 0.3);
        }

        nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 2.2rem;
            font-weight: 900;
            background: linear-gradient(135deg, #8b5cf6, #ec4899, #f59e0b);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: -1px;
        }

        .wallet-connect {
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
            color: white;
            border: none;
            padding: 0.8rem 1.8rem;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 700;
            font-size: 0.95rem;
            transition: all 0.3s ease;
            box-shadow: 0 4px 20px rgba(139, 92, 246, 0.4);
        }

        .wallet-connect:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 30px rgba(139, 92, 246, 0.6);
        }

        .wallet-connect.connected {
            background: linear-gradient(135deg, #10b981, #059669);
        }

        .hero {
            text-align: center;
            padding: 3rem 0 2rem;
        }

        .hero h1 {
            font-size: 3.5rem;
            font-weight: 900;
            margin-bottom: 1rem;
            background: linear-gradient(135deg, #8b5cf6, #ec4899);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .hero p {
            font-size: 1.3rem;
            opacity: 0.8;
            margin-bottom: 1rem;
        }

        .network-badge {
            display: inline-block;
            background: rgba(59, 130, 246, 0.2);
            border: 2px solid #3b82f6;
            padding: 0.5rem 1.2rem;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .pools-section {
            padding: 3rem 0;
        }

        .pools-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(380px, 1fr));
            gap: 2rem;
            margin-top: 2rem;
        }

        .pool-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 2px solid rgba(139, 92, 246, 0.3);
            border-radius: 24px;
            padding: 2rem;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .pool-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #8b5cf6, #ec4899, #f59e0b);
        }

        .pool-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 20px 60px rgba(139, 92, 246, 0.4);
            border-color: rgba(139, 92, 246, 0.6);
        }

        .pool-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .pool-title {
            font-size: 1.8rem;
            font-weight: 800;
            background: linear-gradient(135deg, #8b5cf6, #ec4899);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .pool-badge {
            background: rgba(139, 92, 246, 0.2);
            border: 1px solid #8b5cf6;
            padding: 0.4rem 0.8rem;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .timer {
            background: rgba(236, 72, 153, 0.15);
            border: 2px solid #ec4899;
            padding: 1rem;
            border-radius: 16px;
            text-align: center;
            margin-bottom: 1.5rem;
        }

        .timer-label {
            font-size: 0.85rem;
            opacity: 0.8;
            margin-bottom: 0.5rem;
        }

        .timer-display {
            font-size: 2rem;
            font-weight: 900;
            font-family: 'Courier New', monospace;
            color: #ec4899;
        }

        .pool-stats {
            margin-bottom: 1.5rem;
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            padding: 0.8rem 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .stat-row:last-child {
            border-bottom: none;
        }

        .stat-label {
            opacity: 0.7;
            font-size: 0.95rem;
        }

        .stat-value {
            font-weight: 700;
            font-size: 1.1rem;
            color: #f59e0b;
        }

        .ticket-input-group {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .ticket-input {
            flex: 1;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(139, 92, 246, 0.3);
            padding: 0.9rem;
            border-radius: 12px;
            color: white;
            font-size: 1rem;
            font-weight: 600;
        }

        .ticket-input:focus {
            outline: none;
            border-color: #8b5cf6;
            background: rgba(255, 255, 255, 0.15);
        }

        .buy-button {
            width: 100%;
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
            color: white;
            border: none;
            padding: 1.1rem;
            border-radius: 14px;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 20px rgba(139, 92, 246, 0.4);
        }

        .buy-button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 30px rgba(139, 92, 246, 0.6);
        }

        .buy-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .history-section {
            padding: 3rem 0;
            background: rgba(0, 0, 0, 0.3);
        }

        .section-title {
            font-size: 2.5rem;
            font-weight: 900;
            text-align: center;
            margin-bottom: 2rem;
            background: linear-gradient(135deg, #8b5cf6, #ec4899);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .history-table {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 2px solid rgba(139, 92, 246, 0.3);
            border-radius: 20px;
            overflow: hidden;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 1.2rem;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        th {
            background: rgba(139, 92, 246, 0.2);
            font-weight: 700;
            color: #8b5cf6;
            text-transform: uppercase;
            font-size: 0.85rem;
            letter-spacing: 1px;
        }

        td {
            font-family: 'Courier New', monospace;
        }

        .prize-amount {
            color: #f59e0b;
            font-weight: 700;
            font-size: 1.1rem;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(8px);
        }

        .modal-content {
            background: linear-gradient(135deg, #1a1f3a, #2d1b4e);
            margin: 10% auto;
            padding: 2.5rem;
            border: 2px solid rgba(139, 92, 246, 0.5);
            border-radius: 24px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 2rem;
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
        }

        .close:hover {
            color: #fff;
        }

        .modal h2 {
            margin-bottom: 2rem;
            font-size: 1.8rem;
        }

        .wallet-option {
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(139, 92, 246, 0.3);
            padding: 1.2rem;
            border-radius: 16px;
            margin-bottom: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .wallet-option:hover {
            border-color: #8b5cf6;
            background: rgba(139, 92, 246, 0.1);
            transform: translateX(5px);
        }

        .wallet-icon {
            font-size: 2rem;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 1.2rem 1.8rem;
            border-radius: 12px;
            font-weight: 600;
            z-index: 3000;
            display: none;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .notification.success {
            background: linear-gradient(135deg, #10b981, #059669);
        }

        .notification.error {
            background: linear-gradient(135deg, #ef4444, #dc2626);
        }

        .notification.info {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
        }

        @media (max-width: 768px) {
            .pools-grid {
                grid-template-columns: 1fr;
            }
            
            .hero h1 {
                font-size: 2.5rem;
            }
            
            table {
                font-size: 0.85rem;
            }
            
            th, td {
                padding: 0.8rem;
            }
        }
    </style>
</head>
<body>
    <header>
        <nav class="container">
            <div class="logo">🎰 DeCasino</div>
            <button class="wallet-connect" id="walletBtn">Connect Wallet</button>
        </nav>
    </header>

    <section class="hero">
        <div class="container">
            <h1>On-Chain Lottery</h1>
            <p>Provably fair • Transparent • Decentralized</p>
            <div class="network-badge">⚡ Base Sepolia Testnet</div>
            <div style="margin-top: 1.5rem;">
                <button id="faucetBtn" class="wallet-connect" style="background: linear-gradient(135deg, #10b981, #059669); margin-right: 1rem; display: none;">
                    💧 Get Test Tokens (1000 mUSDT)
                </button>
                <span id="faucetCooldown" style="color: #fbbf24; font-weight: 600; display: none;"></span>
                <div id="tokenBalance" style="margin-top: 1rem; font-size: 1.1rem; font-weight: 600; display: none;">
                    Balance: <span id="balanceAmount">0</span> mUSDT
                </div>
            </div>
        </div>
    </section>

    <section class="pools-section">
        <div class="container">
            <div class="pools-grid">
                <!-- Hourly Pool -->
                <div class="pool-card">
                    <div class="pool-header">
                        <h3 class="pool-title">Hourly Pool</h3>
                        <span class="pool-badge">Pool #<span id="hourlyPoolId">1</span></span>
                    </div>
                    <div class="timer">
                        <div class="timer-label">Time Remaining</div>
                        <div class="timer-display" id="hourlyTimer">--:--:--</div>
                    </div>
                    <div class="pool-stats">
                        <div class="stat-row">
                            <span class="stat-label">Current Prize Pool</span>
                            <span class="stat-value" id="hourlyPool">0 USDT</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Ticket Price</span>
                            <span class="stat-value">1 USDT</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Total Tickets</span>
                            <span class="stat-value" id="hourlyTickets">0</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Winner Gets</span>
                            <span class="stat-value">90%</span>
                        </div>
                    </div>
                    <div class="ticket-input-group">
                        <input type="number" class="ticket-input" id="hourlyInput" placeholder="Tickets" min="1" value="1">
                    </div>
                    <button class="buy-button" data-pool="hourly">Buy Tickets</button>
                </div>

                <!-- Daily Pool -->
                <div class="pool-card">
                    <div class="pool-header">
                        <h3 class="pool-title">Daily Pool</h3>
                        <span class="pool-badge">Pool #<span id="dailyPoolId">1</span></span>
                    </div>
                    <div class="timer">
                        <div class="timer-label">Time Remaining</div>
                        <div class="timer-display" id="dailyTimer">--:--:--</div>
                    </div>
                    <div class="pool-stats">
                        <div class="stat-row">
                            <span class="stat-label">Current Prize Pool</span>
                            <span class="stat-value" id="dailyPool">0 USDT</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Ticket Price</span>
                            <span class="stat-value">1 USDT</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Total Tickets</span>
                            <span class="stat-value" id="dailyTickets">0</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Winner Gets</span>
                            <span class="stat-value">90%</span>
                        </div>
                    </div>
                    <div class="ticket-input-group">
                        <input type="number" class="ticket-input" id="dailyInput" placeholder="Tickets" min="1" value="1">
                    </div>
                    <button class="buy-button" data-pool="daily">Buy Tickets</button>
                </div>

                <!-- Monthly Pool -->
                <div class="pool-card">
                    <div class="pool-header">
                        <h3 class="pool-title">Monthly Pool</h3>
                        <span class="pool-badge">Pool #<span id="monthlyPoolId">1</span></span>
                    </div>
                    <div class="timer">
                        <div class="timer-label">Time Remaining</div>
                        <div class="timer-display" id="monthlyTimer">--:--:--</div>
                    </div>
                    <div class="pool-stats">
                        <div class="stat-row">
                            <span class="stat-label">Current Prize Pool</span>
                            <span class="stat-value" id="monthlyPool">0 USDT</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Ticket Price</span>
                            <span class="stat-value">1 USDT</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Total Tickets</span>
                            <span class="stat-value" id="monthlyTickets">0</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Winner Gets</span>
                            <span class="stat-value">90%</span>
                        </div>
                    </div>
                    <div class="ticket-input-group">
                        <input type="number" class="ticket-input" id="monthlyInput" placeholder="Tickets" min="1" value="1">
                    </div>
                    <button class="buy-button" data-pool="monthly">Buy Tickets</button>
                </div>
            </div>
        </div>
    </section>

    <section class="history-section">
        <div class="container">
            <h2 class="section-title">Lottery History</h2>
            <div class="history-table">
                <table>
                    <thead>
                        <tr>
                            <th>Pool Type</th>
                            <th>Pool ID</th>
                            <th>Winner Address</th>
                            <th>Prize (USDT)</th>
                            <th>Timestamp</th>
                        </tr>
                    </thead>
                    <tbody id="historyBody">
                        <tr>
                            <td colspan="5" style="text-align: center; opacity: 0.6;">No lottery results yet</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </section>

    <!-- Wallet Connection Modal -->
    <div id="walletModal" class="modal">
        <div class="modal-content">
            <span class="close" id="closeModal">&times;</span>
            <h2>Connect Wallet</h2>
            <div class="wallet-option" id="metaMaskOption">
                <span class="wallet-icon">🦊</span>
                <div>
                    <strong>MetaMask</strong>
                    <div style="font-size: 0.85rem; opacity: 0.7;">Connect with MetaMask</div>
                </div>
            </div>
            <div class="wallet-option" id="rabbyOption">
                <span class="wallet-icon">🐰</span>
                <div>
                    <strong>Rabby Wallet</strong>
                    <div style="font-size: 0.85rem; opacity: 0.7;">Connect with Rabby</div>
                </div>
            </div>
            <div class="wallet-option" id="coinbaseOption">
                <span class="wallet-icon">🔵</span>
                <div>
                    <strong>Coinbase Wallet</strong>
                    <div style="font-size: 0.85rem; opacity: 0.7;">Connect with Coinbase</div>
                </div>
            </div>
            <div class="wallet-option" id="walletConnectOption">
                <span class="wallet-icon">🔗</span>
                <div>
                    <strong>WalletConnect</strong>
                    <div style="font-size: 0.85rem; opacity: 0.7;">Scan with mobile wallet</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification -->
    <div id="notification" class="notification"></div>

    <script>
        // Contract addresses - REPLACE THESE WITH YOUR DEPLOYED CONTRACT ADDRESSES
        const LOTTERY_CONTRACT_ADDRESS = '0x0000000000000000000000000000000000000000';
        const USDT_CONTRACT_ADDRESS = '0x0000000000000000000000000000000000000000'; // MockUSDT address
        const PROTOCOL_WALLET = '0x0000000000000000000000000000000000000000'; // Replace with your protocol wallet
        
        const BASE_CHAIN_ID = '0x14a34'; // Base Sepolia testnet (84532 in hex)
        const BASE_RPC = 'https://sepolia.base.org';

        // Contract ABIs
        const LOTTERY_ABI = [
            "function buyTickets(uint8 poolType, uint256 numTickets) external",
            "function drawWinner(uint8 poolType) external",
            "function getPoolInfo(uint8 poolType) external view returns (uint256 poolAmount, uint256 ticketCount, uint256 poolId, uint256 endTime)",
            "function getHistory(uint8 poolType, uint256 limit) external view returns (tuple(uint256 poolId, address winner, uint256 prize, uint256 timestamp)[])",
            "event TicketPurchased(address indexed buyer, uint8 poolType, uint256 numTickets, uint256 amount)",
            "event WinnerDrawn(uint8 poolType, uint256 poolId, address indexed winner, uint256 prize)"
        ];

        const ERC20_ABI = [
            "function approve(address spender, uint256 amount) external returns (bool)",
            "function allowance(address owner, address spender) external view returns (uint256)",
            "function balanceOf(address account) external view returns (uint256)",
            "function faucet() external",
            "function nextFaucetClaim(address user) external view returns (uint256)",
            "event FaucetClaimed(address indexed user, uint256 amount)"
        ];

        // Pool types enum
        const POOL_TYPES = {
            HOURLY: 0,
            DAILY: 1,
            MONTHLY: 2
        };

        // Global variables
        let provider = null;
        let signer = null;
        let userAddress = null;
        let lotteryContract = null;
        let usdtContract = null;

        // Initialize timers
        function updateTimers() {
            const now = new Date();

            // Hourly timer
            const nextHour = new Date(now);
            nextHour.setUTCHours(now.getUTCHours() + 1, 0, 0, 0);
            updateTimerDisplay('hourlyTimer', nextHour - now);

            // Daily timer
            const nextDay = new Date(now);
            nextDay.setUTCHours(24, 0, 0, 0);
            updateTimerDisplay('dailyTimer', nextDay - now);

            // Monthly timer
            const nextMonth = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth() + 1, 1, 0, 0, 0));
            updateTimerDisplay('monthlyTimer', nextMonth - now);
        }

        function updateTimerDisplay(elementId, milliseconds) {
            const hours = Math.floor(milliseconds / (1000 * 60 * 60));
            const minutes = Math.floor((milliseconds % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((milliseconds % (1000 * 60)) / 1000);

            const elem = document.getElementById(elementId);
            if (elem) {
                elem.textContent = 
                    `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            }
        }

        // Show notification
        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.style.display = 'block';
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, 5000);
        }

        // Modal functions
        function openWalletModal() {
            document.getElementById('walletModal').style.display = 'block';
        }

        function closeWalletModal() {
            document.getElementById('walletModal').style.display = 'none';
        }

        // Connect MetaMask or Rabby
        async function connectMetaMask() {
            try {
                if (typeof window.ethereum === 'undefined') {
                    showNotification('Please install MetaMask or Rabby Wallet!', 'error');
                    return;
                }

                // Request account access
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                
                // Check if on Base network
                const chainId = await window.ethereum.request({ method: 'eth_chainId' });
                if (chainId !== BASE_CHAIN_ID) {
                    try {
                        await window.ethereum.request({
                            method: 'wallet_switchEthereumChain',
                            params: [{ chainId: BASE_CHAIN_ID }],
                        });
                    } catch (switchError) {
                        if (switchError.code === 4902) {
                            await window.ethereum.request({
                                method: 'wallet_addEthereumChain',
                                params: [{
                                    chainId: BASE_CHAIN_ID,
                                    chainName: 'Base',
                                    nativeCurrency: { name: 'Ethereum', symbol: 'ETH', decimals: 18 },
                                    rpcUrls: [BASE_RPC],
                                    blockExplorerUrls: ['https://basescan.org']
                                }]
                            });
                        }
                    }
                }

                provider = new ethers.BrowserProvider(window.ethereum);
                signer = await provider.getSigner();
                userAddress = accounts[0];

                // Initialize contracts
                lotteryContract = new ethers.Contract(LOTTERY_CONTRACT_ADDRESS, LOTTERY_ABI, signer);
                usdtContract = new ethers.Contract(USDT_CONTRACT_ADDRESS, ERC20_ABI, signer);

                // Detect which wallet is being used
                const walletName = window.ethereum.isRabby ? 'Rabby' : 'MetaMask';

                // Update UI
                document.getElementById('walletBtn').textContent = 
                    `${userAddress.slice(0, 6)}...${userAddress.slice(-4)}`;
                document.getElementById('walletBtn').classList.add('connected');
                
                closeWalletModal();
                showNotification(`${walletName} connected successfully!`, 'success');
                
                // Load pool data
                await loadPoolData();
                await loadHistory();
                await updateTokenBalance();
                await checkFaucetCooldown();

                // Listen for events
                setupEventListeners();

            } catch (error) {
                console.error('Connection error:', error);
                showNotification('Failed to connect wallet: ' + error.message, 'error');
            }
        }

        // Connect Rabby Wallet specifically
        async function connectRabby() {
            try {
                // Check if Rabby is installed
                if (typeof window.ethereum === 'undefined' || !window.ethereum.isRabby) {
                    showNotification('Please install Rabby Wallet! Visit rabby.io', 'error');
                    window.open('https://rabby.io', '_blank');
                    return;
                }

                // Use the same connection flow as MetaMask
                await connectMetaMask();

            } catch (error) {
                console.error('Rabby connection error:', error);
                showNotification('Failed to connect Rabby: ' + error.message, 'error');
            }
        }

        // Update token balance
        async function updateTokenBalance() {
            if (!usdtContract || !userAddress) return;

            try {
                const balance = await usdtContract.balanceOf(userAddress);
                const formattedBalance = ethers.formatUnits(balance, 6);
                
                document.getElementById('balanceAmount').textContent = parseFloat(formattedBalance).toFixed(2);
                document.getElementById('tokenBalance').style.display = 'block';
            } catch (error) {
                console.error('Error loading balance:', error);
            }
        }

        // Check faucet cooldown
        async function checkFaucetCooldown() {
            if (!usdtContract || !userAddress) return;

            try {
                const cooldownSeconds = await usdtContract.nextFaucetClaim(userAddress);
                const faucetBtn = document.getElementById('faucetBtn');
                const cooldownText = document.getElementById('faucetCooldown');
                
                faucetBtn.style.display = 'inline-block';
                
                if (cooldownSeconds == 0) {
                    faucetBtn.disabled = false;
                    faucetBtn.textContent = '💧 Get Test Tokens (1000 mUSDT)';
                    cooldownText.style.display = 'none';
                } else {
                    faucetBtn.disabled = true;
                    const minutes = Math.ceil(Number(cooldownSeconds) / 60);
                    faucetBtn.textContent = '⏳ Faucet Cooldown Active';
                    cooldownText.textContent = `Available in ${minutes} minutes`;
                    cooldownText.style.display = 'inline-block';
                    
                    // Recheck after cooldown
                    setTimeout(checkFaucetCooldown, Number(cooldownSeconds) * 1000);
                }
            } catch (error) {
                console.error('Error checking faucet cooldown:', error);
            }
        }

        // Claim from faucet
        async function claimFaucet() {
            if (!usdtContract || !userAddress) {
                showNotification('Please connect your wallet first', 'error');
                return;
            }

            try {
                showNotification('Claiming test tokens from faucet...', 'info');
                
                const tx = await usdtContract.faucet();
                await tx.wait();
                
                showNotification('Successfully claimed 1000 mUSDT! 🎉', 'success');
                
                await updateTokenBalance();
                await checkFaucetCooldown();
                
            } catch (error) {
                console.error('Faucet claim error:', error);
                
                if (error.message.includes('cooldown')) {
                    showNotification('Faucet cooldown active. Please wait before claiming again.', 'error');
                } else {
                    showNotification('Failed to claim tokens: ' + error.message, 'error');
                }
                
                await checkFaucetCooldown();
            }
        }

        // Load pool data from contract
        async function loadPoolData() {
            if (!lotteryContract) return;

            try {
                // Load hourly pool
                const hourlyInfo = await lotteryContract.getPoolInfo(POOL_TYPES.HOURLY);
                document.getElementById('hourlyPool').textContent = 
                    ethers.formatUnits(hourlyInfo[0], 6) + ' USDT';
                document.getElementById('hourlyTickets').textContent = hourlyInfo[1].toString();
                document.getElementById('hourlyPoolId').textContent = hourlyInfo[2].toString();

                // Load daily pool
                const dailyInfo = await lotteryContract.getPoolInfo(POOL_TYPES.DAILY);
                document.getElementById('dailyPool').textContent = 
                    ethers.formatUnits(dailyInfo[0], 6) + ' USDT';
                document.getElementById('dailyTickets').textContent = dailyInfo[1].toString();
                document.getElementById('dailyPoolId').textContent = dailyInfo[2].toString();

                // Load monthly pool
                const monthlyInfo = await lotteryContract.getPoolInfo(POOL_TYPES.MONTHLY);
                document.getElementById('monthlyPool').textContent = 
                    ethers.formatUnits(monthlyInfo[0], 6) + ' USDT';
                document.getElementById('monthlyTickets').textContent = monthlyInfo[1].toString();
                document.getElementById('monthlyPoolId').textContent = monthlyInfo[2].toString();

            } catch (error) {
                console.error('Error loading pool data:', error);
            }
        }

        // Buy tickets
        async function buyTickets(poolType) {
            if (!lotteryContract || !userAddress) {
                showNotification('Please connect your wallet first', 'error');
                openWalletModal();
                return;
            }

            const inputId = poolType + 'Input';
            const numTickets = parseInt(document.getElementById(inputId).value);

            if (!numTickets || numTickets < 1) {
                showNotification('Please enter a valid number of tickets', 'error');
                return;
            }

            try {
                showNotification('Processing ticket purchase...', 'info');

                const poolTypeEnum = POOL_TYPES[poolType.toUpperCase()];
                const amount = ethers.parseUnits((numTickets * 1).toString(), 6); // 1 USDT per ticket

                // Check USDT balance
                const balance = await usdtContract.balanceOf(userAddress);
                if (balance < amount) {
                    showNotification('Insufficient USDT balance', 'error');
                    return;
                }

                // Check and approve USDT if needed
                const allowance = await usdtContract.allowance(userAddress, LOTTERY_CONTRACT_ADDRESS);
                if (allowance < amount) {
                    showNotification('Approving USDT...', 'info');
                    const approveTx = await usdtContract.approve(LOTTERY_CONTRACT_ADDRESS, amount);
                    await approveTx.wait();
                }

                // Buy tickets
                showNotification('Buying tickets...', 'info');
                const tx = await lotteryContract.buyTickets(poolTypeEnum, numTickets);
                await tx.wait();

                showNotification(`Successfully bought ${numTickets} ticket(s)!`, 'success');
                
                // Refresh pool data
                await loadPoolData();
                
                // Reset input
                document.getElementById(inputId).value = '1';

            } catch (error) {
                console.error('Error buying tickets:', error);
                showNotification('Failed to buy tickets: ' + error.message, 'error');
            }
        }

        // Load history from contract
        async function loadHistory() {
            if (!lotteryContract) return;

            try {
                const historyBody = document.getElementById('historyBody');
                historyBody.innerHTML = '';

                // Load history for all pool types
                const poolNames = ['Hourly', 'Daily', 'Monthly'];
                
                for (let i = 0; i < 3; i++) {
                    try {
                        const history = await lotteryContract.getHistory(i, 20);
                        
                        for (const entry of history) {
                            const row = document.createElement('tr');
                            const timestamp = new Date(Number(entry.timestamp) * 1000);
                            
                            row.innerHTML = `
                                <td>${poolNames[i]}</td>
                                <td>#${entry.poolId}</td>
                                <td>${entry.winner}</td>
                                <td class="prize-amount">${ethers.formatUnits(entry.prize, 6)} USDT</td>
                                <td>${timestamp.toUTCString()}</td>
                            `;
                            
                            historyBody.appendChild(row);
                        }
                    } catch (err) {
                        console.log(`No history for ${poolNames[i]} pool yet`);
                    }
                }

                if (historyBody.children.length === 0) {
                    historyBody.innerHTML = '<tr><td colspan="5" style="text-align: center; opacity: 0.6;">No lottery results yet</td></tr>';
                }

            } catch (error) {
                console.error('Error loading history:', error);
            }
        }

        // Setup event listeners for contract events
        function setupEventListeners() {
            if (!lotteryContract) return;

            // Listen for ticket purchases
            lotteryContract.on("TicketPurchased", async (buyer, poolType, numTickets, amount) => {
                if (buyer.toLowerCase() === userAddress.toLowerCase()) {
                    showNotification(`Your tickets have been confirmed!`, 'success');
                    await updateTokenBalance();
                }
                await loadPoolData();
            });

            // Listen for winner draws
            lotteryContract.on("WinnerDrawn", async (poolType, poolId, winner, prize) => {
                const poolNames = ['Hourly', 'Daily', 'Monthly'];
                const prizeAmount = ethers.formatUnits(prize, 6);
                
                if (winner.toLowerCase() === userAddress.toLowerCase()) {
                    showNotification(`🎉 Congratulations! You won ${prizeAmount} mUSDT in the ${poolNames[poolType]} pool!`, 'success');
                    await updateTokenBalance();
                } else {
                    showNotification(`${poolNames[poolType]} pool #${poolId} winner drawn: ${prizeAmount} mUSDT`, 'info');
                }
                
                await loadPoolData();
                await loadHistory();
            });

            // Listen for faucet claims
            usdtContract.on("FaucetClaimed", async (user, amount) => {
                if (user.toLowerCase() === userAddress.toLowerCase()) {
                    await updateTokenBalance();
                    await checkFaucetCooldown();
                }
            });
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', () => {
            // Update timers every second
            updateTimers();
            setInterval(updateTimers, 1000);

            // Wallet button click
            document.getElementById('walletBtn').addEventListener('click', () => {
                if (!userAddress) {
                    openWalletModal();
                }
            });

            // Faucet button click
            document.getElementById('faucetBtn').addEventListener('click', claimFaucet);

            // Modal close button
            document.getElementById('closeModal').addEventListener('click', closeWalletModal);

            // Wallet options
            document.getElementById('metaMaskOption').addEventListener('click', connectMetaMask);
            document.getElementById('rabbyOption').addEventListener('click', connectRabby);
            document.getElementById('coinbaseOption').addEventListener('click', () => {
                showNotification('Coinbase Wallet support coming soon', 'info');
            });
            document.getElementById('walletConnectOption').addEventListener('click', () => {
                showNotification('WalletConnect integration coming soon', 'info');
            });

            // Buy ticket buttons
            document.querySelectorAll('.buy-button').forEach(button => {
                button.addEventListener('click', (e) => {
                    const poolType = e.target.getAttribute('data-pool');
                    buyTickets(poolType);
                });
            });

            // Close modal when clicking outside
            window.addEventListener('click', (event) => {
                const modal = document.getElementById('walletModal');
                if (event.target === modal) {
                    closeWalletModal();
                }
            });

            // Check if wallet is already connected
            if (window.ethereum && window.ethereum.selectedAddress) {
                connectMetaMask();
            }
        });
    </script>
</body>
</html>
